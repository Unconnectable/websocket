# 压力测试工具 (`press_test`)

这是一个为 `websocket` 聊天服务器量身定制的异步高性能压力测试工具。

## 设计目标

本工具旨在解决以下核心问题：

1.  **量化性能：** 提供精确的性能指标，如吞吐量（TPS）和延迟（Latency），以客观评估服务器性能。
2.  **模拟真实负载：** 能够模拟大量并发用户，并执行登录、收发消息等操作。
3.  **发现瓶颈：** 通过在不同压力下运行，帮助定位服务器的性能瓶颈。
4.  **验证优化：** 为架构的每次迭代（例如，从`Mutex`锁模型重构为 Actor 模型）提供前后性能对比的数据支撑。

## 架构设计

工具采用三层架构，以实现清晰的职责分离：

1.  **Orchestrator (编排器 - `main.rs`):**

    - 作为“总指挥”，负责读取`config.toml`配置文件。
    - 根据配置并发启动指定数量的`Virtual Client`任务。
    - 在所有任务结束后，聚合`Metrics Collector`的数据，并生成最终的 JSON 性能报告。

2.  **Virtual Client (虚拟客户端 - `client.rs`):**

    - 作为“一线士兵”，每个客户端在一个独立的`tokio`任务中运行，模拟真实用户。
    - 负责与服务器建立 TCP 连接，并执行登录握手协议。
    - 在测试期间，根据配置的`think_time_ms`（思考时间）模拟用户行为，循环发送广播消息。
    - **核心职责：** 精确测量每次消息交互的延迟，并将本地统计数据（发送/接收数、延迟分布等）汇总到全局的`Metrics Collector`。

3.  **Metrics Collector (指标收集器 - `metrics.rs`):**
    - 作为“战地记录员”，是一个全局、线程安全的数据聚合器。
    - 为了减少锁竞争，每个`Virtual Client`都在本地记录指标，只在任务结束时才将数据一次性合并到全局收集器中。
    - 使用`hdrhistogram`库来高效、准确地记录延迟分布，最终用于计算 P50, P95, P99 等关键延迟指标。

## 如何使用

1.  **启动服务器：**
    在项目根目录打开一个终端，运行服务器。使用`--release`模式以获得最佳性能。

    ```bash
    cargo run --release
    ```

2.  **配置测试场景：**
    编辑 `press_test/config.toml`文件，可以定义一个或多个测试步骤 (`[[steps]]`)。每个步骤可以设置不同的并发数、测试时长等。

3.  **运行压力测试：**
    在 `press_test` 目录打开第二个终端，运行压测工具。

    ```bash
    cd press_test
    cargo run --release
    ```

4.  **查看结果：**
    - **控制台：** 测试的每个步骤结束后，会在控制台打印一份简要的性能总结。
    - **JSON 报告：** 详细的性能报告会以 JSON 格式保存在 `press_test/reports/` 目录下。文件名包含时间戳和测试场景信息，便于归档和对比。
    - **日志：** 详细的运行日志会保存在 `press_test/logs/` 目录下，每天生成一个新文件，用于问题排查。

## 核心指标解释

- **TPS (Transactions Per Second):** 每秒处理的事务数。`Receive TPS`尤其重要，它反映了服务器的广播分发能力。
- **Latency (ms):** 延迟，单位毫秒。
  - **P50:** 中位数延迟，代表了 50%用户的体验。
  - **P95:** 95 百分位延迟，代表了绝大多数用户的体验。
  - **P99:** 99 百分位延迟，是衡量系统在高压下稳定性的关键指标，反映了最差情况下的用户体验。
